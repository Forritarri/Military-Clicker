<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Armory Forge — Craft & Click</title>
<style>
:root{
  --bg:#0b1d0d;--panel:#112715;--muted:#9db79b;--accent:#7aa06e;--accent-2:#3f6d3f;
  --glass: rgba(255,255,255,0.02);--text:#eaf6ea;--mono:'Courier New',monospace;--rounded:12px;
  --huge:40px;--bigger:28px;
}
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:0;padding:0;}
html,body{height:100%;background:linear-gradient(180deg,var(--bg),#08160a);color:var(--text);font-size:14px;}
.app{padding:18px;display:flex;flex-direction:column;gap:14px;min-height:100vh;}
.header{display:flex;justify-content:space-between;align-items:center;}
.brand{display:flex;gap:12px;align-items:center;}
.logo{width:72px;height:72px;border-radius:12px;background:linear-gradient(135deg,rgba(255,255,255,0.03),rgba(80,110,80,0.11));display:flex;align-items:center;justify-content:center;font-weight:800;font-family:var(--mono);color:var(--muted);font-size:20px;border:1px solid rgba(255,255,255,0.03);}
.title{font-size:20px;font-weight:800;}
.tagline{font-size:12px;color:var(--muted);margin-top:4px;}
.big-money{font-family:var(--mono);font-weight:900;font-size:var(--huge);color:var(--accent);text-shadow:0 6px 18px rgba(0,0,0,0.6);}
.main{display:flex;gap:16px;align-items:flex-start;}
.left-panel{width:360px;background:var(--panel);padding:16px;border-radius:var(--rounded);box-shadow:0 8px 28px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03);}
.center-panel{flex:1;background:linear-gradient(180deg, rgba(26,52,26,0.12), rgba(18,36,20,0.04));padding:16px;border-radius:var(--rounded);min-height:600px;border:1px solid rgba(255,255,255,0.02);}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
.tab{background:var(--glass);padding:10px 12px;border-radius:10px;cursor:pointer;color:var(--muted);font-size:14px;border:1px solid rgba(255,255,255,0.02);}
.tab.active{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:white;box-shadow:0 10px 28px rgba(0,0,0,0.6);}
.panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);}
.resource{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);margin-bottom:10px;}
.left{display:flex;gap:12px;align-items:center;}
.badge{width:56px;height:56px;border-radius:10px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--muted);font-family:var(--mono);font-size:20px;}
.res-name{font-weight:800;font-size:16px;}
.res-qty{font-family:var(--mono);font-size:var(--bigger);font-weight:900;color:var(--text);}
.res-price{font-family:var(--mono);font-size:18px;font-weight:800;color:var(--muted);text-align:right;}
.btn{background:var(--accent);border:none;padding:10px 12px;border-radius:9px;color:white;cursor:pointer;transition:transform 0.12s ease,box-shadow 0.12s ease;box-shadow:0 6px 14px rgba(0,0,0,0.45);}
.btn:hover{transform:translateY(-3px);box-shadow:0 12px 24px rgba(0,0,0,0.6);}
.btn:active{transform:translateY(-1px) scale(0.995);}
.btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);}
.small{padding:7px 8px;border-radius:8px;font-size:13px;}
.item-card{padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);display:flex;flex-direction:column;gap:8px;min-height:84px;border:1px solid rgba(255,255,255,0.02);}
#log{max-height:220px;overflow:auto;background:rgba(255,255,255,0.01);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);line-height:1.9;}
#log div{padding:6px 4px;margin-bottom:6px;border-radius:6px;background:rgba(0,0,0,0.03);}
.dynamic-large{font-family:var(--mono);font-weight:900;font-size:24px;color:var(--accent);}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:10px 6px;}
.footer{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;padding:6px 10px;border-radius:8px;background:transparent;border-top:1px solid rgba(255,255,255,0.02);margin-top:10px;}
@media (max-width:960px){.main{flex-direction:column}.left-panel{width:100%}.center-panel{width:100%}}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header">
    <div class="brand">
      <div class="logo">AF</div>
      <div>
        <div class="title">Armory Forge</div>
        <div class="tagline">Live Free, Die Free — Forge & Click</div>
      </div>
    </div>
    <div style="text-align:right">
      <div id="moneyDisplay" class="big-money">$1,200</div>
      <div style="color:var(--muted);font-size:12px;margin-top:6px">What the hell is a kilometer!? (Easter)</div>
    </div>
  </div>

  <div class="main">
    <div class="left-panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:900;font-size:16px">Stock & Market</div>
          <div style="font-size:12px;color:var(--muted)">Prices change. Keep an eye!</div>
        </div>
        <div style="text-align:right">
          <div id="moneyShort" class="dynamic-large">$1.2k</div>
          <div style="font-size:12px;color:var(--muted)">Cash on hand</div>
        </div>
      </div>

      <div id="resourceList" style="margin-top:12px"></div>

      <div style="margin-top:10px" class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Quick Actions</div>
          <div class="small-note" style="color:var(--muted)">For early play</div>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button class="btn small" id="scavengeBtn">Scavenge</button>
          <button class="btn small secondary" id="sellLowBtn">Sell Low Qty</button>
          <button class="btn small" id="autoSellBtn">Auto-Sell Low</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div style="font-weight:800">Factory Snapshot</div>
        <div id="factorySnapshot" class="small-note" style="margin-top:6px">No factories yet</div>
      </div>

      <div style="flex:1"></div>

      <div class="footer">
        <div>v1.1 — Simplified</div>
        <div id="clock" style="color:var(--muted)"></div>
      </div>
    </div>

    <div class="center-panel">
      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="dashboard">Dashboard</div>
        <div class="tab" data-tab="factories">Factories</div>
        <div class="tab" data-tab="market">Market</div>
        <div class="tab" data-tab="upgrades">Upgrades</div>
        <div class="tab" data-tab="research">Research</div>
        <div class="tab" data-tab="inventory">Inventory</div>
        <div class="tab" data-tab="settings">Settings</div>
      </div>

      <div id="tabContent">
        <div class="tab-page" id="dashboard">
          <div style="display:flex;gap:16px;align-items:flex-start;">
            <div style="flex:1">
              <div style="font-weight:900;font-size:18px">Forge Control</div>
              <div style="color:var(--muted);margin-top:6px">Click to craft or queue factories to produce.</div>

              <div style="display:grid;grid-template-columns:1fr 320px;gap:12px;margin-top:12px">
                <div class="panel">
                  <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                      <div style="font-weight:900;font-size:16px">Manual Craft</div>
                      <div style="color:var(--muted);font-size:12px">Click to craft basic items and earn research.</div>
                    </div>
                    <div class="res-qty" id="manualRate">0/s</div>
                  </div>

                  <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
                    <select id="manualProduct" style="flex:1;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--text)"></select>
                    <button class="btn" id="craftBtn">Craft</button>
                    <button class="btn secondary small" id="bulkBtn">Craft x5</button>
                  </div>

                  <div style="margin-top:10px" id="manualHelp" class="small-note">Manual crafting is immediate and grants research points.</div>
                </div>

                <div class="panel">
                  <div style="font-weight:900">Production Queue</div>
                  <div id="queueStatus" class="small-note" style="margin-top:6px">0 queued</div>
                  <div id="queueList" style="margin-top:12px;max-height:240px;overflow:auto"></div>
                </div>
              </div>

              <div style="margin-top:12px">
                <div style="font-weight:900">Recent Events</div>
                <div id="log" style="margin-top:8px"></div>
              </div>

            </div>

            <div style="width:320px">
              <div style="font-weight:900">Quick Factory View</div>
              <div id="quickFactories" style="margin-top:8px;display:flex;flex-direction:column;gap:8px"></div>

              <div style="height:12px"></div>

              <div class="panel">
                <div style="font-weight:900">Market Feed</div>
                <div id="marketFeed" class="small-note" style="margin-top:8px"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-page" id="factories" style="display:none">
          <div style="display:flex;gap:12px;">
            <div style="flex:1">
              <div style="font-weight:900">Factories</div>
              <div style="color:var(--muted);margin-top:6px">Purchase factories to automate production.</div>
              <div style="margin-top:12px" id="factoryList"></div>
            </div>

            <div style="width:340px">
              <div style="font-weight:900">Build Factory</div>
              <div class="small-note">Create a custom factory — simpler options for quick play.</div>

              <div style="margin-top:8px" class="panel">
                <div style="display:flex;flex-direction:column;gap:8px">
                  <label>Type
                    <select id="designerType" style="margin-left:8px">
                      <option value="handgun">Handgun Shop</option>
                      <option value="rifle">Rifle Plant</option>
                      <option value="ammo">Ammo Line</option>
                    </select>
                  </label>
                  <label>Queue Size <input id="designerQueue" type="number" value="4" min="1" max="16" style="width:80px;margin-left:8px"></label>
                  <label>Speed <input id="designerSpeed" type="number" value="1" step="0.1" min="0.5" max="3" style="width:80px;margin-left:8px"></label>

                  <div style="display:flex;gap:8px">
                    <button class="btn" id="createFactoryBtn">Create</button>
                    <button class="btn secondary" id="create2Btn">Create x2</button>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <div class="tab-page" id="market" style="display:none">
          <div style="display:flex;gap:12px;">
            <div style="flex:1">
              <div style="font-weight:900">Marketplace</div>
              <div style="color:var(--muted);margin-top:6px">Buy raw resources, sell finished goods.</div>
              <div style="margin-top:12px" id="marketList" class="panel"></div>
            </div>

            <div style="width:320px">
              <div style="font-weight:900">Price Trends</div>
              <div id="priceTrends" class="panel small-note" style="min-height:220px"></div>
            </div>
          </div>
        </div>

        <div class="tab-page" id="upgrades" style="display:none">
          <div style="display:flex;gap:12px;">
            <div style="flex:1">
              <div style="font-weight:900">Upgrades</div>
              <div style="color:var(--muted);margin-top:6px">Fewer, meaningful upgrades to keep the game simpler.</div>
              <div style="margin-top:12px" id="upgradeList"></div>
            </div>

            <div style="width:320px">
              <div class="panel">
                <div style="font-weight:900">Installed</div>
                <div id="installed" class="small-note" style="margin-top:8px">None</div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-page" id="research" style="display:none">
          <div>
            <div style="font-weight:900">Research</div>
            <div id="researchList" style="margin-top:12px"></div>
          </div>
        </div>

        <div class="tab-page" id="inventory" style="display:none">
          <div>
            <div style="font-weight:900">Inventory</div>
            <div style="color:var(--muted);margin-top:6px">Your stockpile of weapons and ammo.</div>
            <div id="inventoryList" style="margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px"></div>
          </div>
        </div>

        <div class="tab-page" id="settings" style="display:none">
          <div>
            <div style="font-weight:900">Settings</div>
            <div style="color:var(--muted);margin-top:6px">Adjust how the interface behaves.</div>

            <div style="margin-top:12px" class="panel">
              <div class="setting-row">
                <div style="font-weight:700">Message Retention</div>
                <div><input id="messageSlider" type="range" min="0" max="3" value="2"></div>
              </div>
              <div style="margin-top:6px;color:var(--muted)" id="messageLabel">All messages</div>

              <div class="setting-row" style="margin-top:12px">
                <div>Auto-save interval (sec)</div>
                <div><input id="saveInterval" type="number" value="15" min="5" style="width:80px"></div>
              </div>

              <div class="setting-row" style="margin-top:12px">
                <div>Enable Sound</div>
                <div><input id="audioToggle" type="checkbox"></div>
              </div>

              <div style="margin-top:10px">
                <button class="btn" id="saveNowBtn">Save Now</button>
                <button class="btn secondary" id="exportBtn">Export Save</button>
              </div>

              <div style="margin-top:10px;font-size:12px;color:var(--muted)">Message retention controls how many recent log lines are kept: None / Major / All / Very large.</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalBackdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;padding:20px;">
  <div class="panel" id="modal" style="min-width:320px;"></div>
</div>

<script>
/* Simplified Armory Forge — compact, functional, safe (no real construction instructions) */
const uid=(p='id')=>p+'_'+Math.random().toString(36).slice(2,9);
const fmtMoney = n => n<1000?('$'+Math.floor(n)):n<1e6?('$'+(n/1000).toFixed(1)+'k'):('$'+(n/1e6).toFixed(2)+'M');
const randInt=(a,b)=>Math.floor(a+Math.random()*(b-a+1));
const randChoice = arr => arr[Math.floor(Math.random()*arr.length)];

const Game = {
  version:'1.1-slim',
  money:1200,
  resources:{}, resourceDefs:[],
  catalog:[], inventory:{}, factories:[], upgrades:{}, researchPoints:0,
  stats:{produced:{}, sold:{}, clicks:0}, market:{prices:{},trends:{}},
  settings:{saveInterval:15,audio:false,messageRetention:2},
  lastTick:Date.now(), _lastSaveCheck:Date.now()
};

/* Resources */
Game.resourceDefs = [
  {id:'metal', name:'Metal', icon:'M', basePrice:8, volatility:0.18, storage:600},
  {id:'prop_low', name:'Propellant — Low', icon:'pL', basePrice:3, volatility:0.25, storage:600},
  {id:'prop_med', name:'Propellant — Medium', icon:'pM', basePrice:7, volatility:0.22, storage:400},
  {id:'prop_high', name:'Propellant — High', icon:'pH', basePrice:18, volatility:0.28, storage:200},
];
Game.resourceDefs.forEach(r=>Game.resources[r.id]=randInt(8,28));

/* Catalog helper */
function regItem(o){ Game.catalog.push(Object.assign({id:uid('item')},o)); }

/* Items */
regItem({id:'block-compact',name:'Block-Compact (9mm)',type:'weapon',family:'handgun',caliber:'9mm',resources:{metal:8,prop_low:4},value:220,prodTime:2.2,tier:1});
regItem({id:'barr-45',name:'Barr-45 (.45)',type:'weapon',family:'handgun',caliber:'.45ACP',resources:{metal:12,prop_med:5},value:420,prodTime:3.2,tier:2});
regItem({id:'harv-556',name:'Harvester 5.56',type:'weapon',family:'rifle',caliber:'5.56mm',resources:{metal:28,prop_med:12},value:980,prodTime:8.0,tier:3});
regItem({id:'prec-308',name:'Precise .308',type:'weapon',family:'precision',caliber:'.308Win',resources:{metal:44,prop_high:18},value:4200,prodTime:18,tier:4});
regItem({id:'ammo-9mm',name:'9mm Batch',type:'ammo',caliber:'9mm',resources:{metal:1,prop_low:6},perStack:50,value:38,prodTime:1.0,tier:1});
regItem({id:'ammo-45',name:'.45 Batch',type:'ammo',caliber:'.45',resources:{metal:1,prop_med:7},perStack:40,value:48,prodTime:1.4,tier:1});
regItem({id:'ammo-308',name:'.308 Pack',type:'ammo',caliber:'.308',resources:{metal:2,prop_high:10},perStack:30,value:92,prodTime:2.8,tier:2});

Game.inventory['ammo-9mm']=2; Game.inventory['block-compact']=1;

/* Factory prototypes + starter factory */
const FactoryProtos = {
  handgun:{name:'Handgun Shop',baseCost:600,baseSpeed:1.0,baseQueue:4,tag:'handgun'},
  rifle:{name:'Rifle Plant',baseCost:4200,baseSpeed:0.85,baseQueue:3,tag:'rifle'},
  ammo:{name:'Ammo Line',baseCost:900,baseSpeed:1.6,baseQueue:6,tag:'ammo'}
};
Game.factories.push({id:uid('fac'),proto:'handgun',name:'Starter Handgun Shop',level:1,speed:FactoryProtos.handgun.baseSpeed,queueSize:4,activeQueue:[],running:true,lastTick:Date.now()});

/* Market */
Game.resourceDefs.forEach(r=>{ Game.market.prices[r.id]=r.basePrice*(0.9+Math.random()*0.3); Game.market.trends[r.id]=(Math.random()-0.5)*0.03; });
function updateMarket(dt){ Game.resourceDefs.forEach(r=>{ const cur=Game.market.prices[r.id]; let trend=Game.market.trends[r.id]+(Math.random()-0.5)*0.01*dt; Game.market.trends[r.id]=trend*0.995; let shock=(Math.random()-0.5)*r.volatility*(0.4+Math.random()*0.8)*dt; let np=cur*(1+shock+trend); np=Math.max(0.35*r.basePrice,Math.min(np,5*r.basePrice)); Game.market.prices[r.id]=np; }); }

/* Production */
function canAfford(costs){ for(const k in costs) if((Game.resources[k]||0)<costs[k]) return false; return true; }
function deduct(costs){ for(const k in costs) Game.resources[k]=Math.max(0,(Game.resources[k]||0)-costs[k]); }
function addInv(id,q=1){ Game.inventory[id]=(Game.inventory[id]||0)+q; Game.stats.produced[id]=(Game.stats.produced[id]||0)+q; }

function enqueue(factory,itemId,qty=1){
  const item=Game.catalog.find(x=>x.id===itemId); if(!item) return false;
  for(let i=0;i<qty;i++){
    if(!canAfford(item.resources)){ pushLog('Insufficient resources for '+item.name); return false; }
    deduct(item.resources);
    const time=item.prodTime/factory.speed*(0.88+Math.random()*0.26);
    factory.activeQueue.push({id:itemId,remaining:time,orig:time});
    pushLog(`Queued ${item.name} in ${factory.name}.`);
  }
  return true;
}
function tickFactory(f,dt){ if(!f.running||!f.activeQueue.length) return;
  const cur=f.activeQueue[0]; cur.remaining -= dt*f.speed*(0.9+Math.random()*0.2);
  if(cur.remaining<=0){ addInv(cur.id,1); f.activeQueue.shift(); pushLog(`${Game.catalog.find(i=>i.id===cur.id).name} finished at ${f.name}.`);
    if(Math.random()<0.06){ const res=randChoice(Game.resourceDefs).id; const amt=randInt(1,3); Game.resources[res]=(Game.resources[res]||0)+amt; pushLog(`Bonus: +${amt} ${res}`); }
  }
}
function autoFill(f){ const suitable=Game.catalog.filter(i=>{ if(f.proto==='ammo') return i.type==='ammo'; if(f.proto==='handgun') return i.family==='handgun'; if(f.proto==='rifle') return i.family==='rifle'||i.family==='precision'; return true; }); if(!suitable.length) return; enqueue(f,randChoice(suitable).id,1); }
function craft(itemId,qty=1){ const item=Game.catalog.find(i=>i.id===itemId); if(!item) return false;
  for(let i=0;i<qty;i++){ if(!canAfford(item.resources)){ pushLog('Not enough resources to craft '+item.name); return false; } deduct(item.resources); addInv(itemId,1); Game.stats.clicks++; Game.researchPoints += 1+randInt(0,2); if(Math.random()<0.12){ const cash=Math.floor(item.value*(0.07+Math.random()*0.14)); Game.money+=cash; pushLog(`Occasional sale: +${fmtMoney(cash)}`); } } return true;
}

/* Upgrades & research */
Game.upgradesCatalog = [
  {id:'u_speed_small',name:'Small Speed Boost',cost:900,apply:()=>{ Game.factories.forEach(f=>f.speed*=1.12); pushLog('Applied Small Speed Boost.'); }},
  {id:'u_auto',name:'Auto-Fill Unlock',cost:600,apply:()=>{ Game.upgrades['u_auto']=true; pushLog('Auto-Fill enabled.'); }},
  {id:'u_market',name:'Market Scanner',cost:500,apply:()=>{ Game.upgrades['u_market']=true; pushLog('Market Scanner active.'); }}
];
Game.researchCatalog = [{id:'r_optic',name:'Optics Integration',cost:120,desc:'Cosmetic & small value boost.'},{id:'r_variant',name:'Variant Blueprint',cost:220,desc:'Unlocks a rare variant.'}];
Game.achDefs = [{id:'first',name:'First Build',cond:g=>Object.values(g.stats.produced||{}).reduce((a,b)=>a+b,0)>=1,reward:()=>{Game.money+=200;pushLog('Achievement: $200');}},{id:'fivefact',name:'Five Factories',cond:g=>g.factories.length>=5,reward:()=>{Game.researchPoints+=50;pushLog('Achievement: +50 RP');}}];

/* Save/load */
function saveGame(){ const s={version:Game.version,money:Game.money,resources:Game.resources,inventory:Game.inventory,factories:Game.factories,upgrades:Game.upgrades,researchPoints:Game.researchPoints,settings:Game.settings,market:Game.market,stats:Game.stats}; localStorage.setItem('armoryforge_save',JSON.stringify(s)); pushLog('Game saved.'); }
function loadGame(){ try{ const raw=localStorage.getItem('armoryforge_save'); if(!raw) return false; const s=JSON.parse(raw); Game.money=s.money||Game.money; Game.resources=s.resources||Game.resources; Game.inventory=s.inventory||Game.inventory; Game.factories=s.factories||Game.factories; Game.upgrades=s.upgrades||Game.upgrades; Game.researchPoints=s.researchPoints||Game.researchPoints; Game.settings=s.settings||Game.settings; Game.market=s.market||Game.market; Game.stats=s.stats||Game.stats; pushLog('Loaded save.'); return true; }catch(e){console.error(e);return false;} }
function exportSave(){ const data=localStorage.getItem('armoryforge_save')||JSON.stringify({version:Game.version}); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='armoryforge_save.json'; a.click(); URL.revokeObjectURL(url); }
function importSaveJSON(txt){ try{ JSON.parse(txt); localStorage.setItem('armoryforge_save',txt); loadGame(); location.reload(); }catch(e){ alert('Invalid JSON'); } }

/* Logging with retention */
function pushLog(text){
  const el=document.getElementById('log'); if(!el) return; const p=document.createElement('div'); p.textContent=`[${(new Date()).toLocaleTimeString()}] ${text}`; el.prepend(p);
  const map=[0,10,200,9999]; const keep=map[Game.settings.messageRetention]||200; while(el.children.length>keep) el.removeChild(el.lastChild);
}

/* Rendering */
function renderResources(){
  const el=document.getElementById('resourceList'); el.innerHTML='';
  Game.resourceDefs.forEach(r=>{ const row=document.createElement('div'); row.className='resource';
    const left=document.createElement('div'); left.className='left';
    const badge=document.createElement('div'); badge.className='badge'; badge.textContent=r.icon;
    const name=document.createElement('div'); name.innerHTML=`<div class="res-name">${r.name}</div><div class="small-note" style="color:var(--muted)">${r.id}</div>`;
    left.appendChild(badge); left.appendChild(name);
    const right=document.createElement('div'); right.style.textAlign='right';
    const price=Game.market.prices[r.id]||r.basePrice; const qty=Game.resources[r.id]||0;
    right.innerHTML=`<div class="res-qty">${qty}</div><div class="res-price">${fmtMoney(price)}</div>`;
    row.appendChild(left); row.appendChild(right); el.appendChild(row);
  });
  document.getElementById('moneyDisplay').textContent=fmtMoney(Game.money);
  document.getElementById('moneyShort').textContent=fmtMoney(Game.money);
}

function renderManualOptions(){ const sel=document.getElementById('manualProduct'); sel.innerHTML=''; const sorted=Game.catalog.slice().sort((a,b)=> (a.tier||1)-(b.tier||1)); sorted.forEach(i=>{ const op=document.createElement('option'); op.value=i.id; op.textContent=`${i.name} — ${i.type==='ammo'?'Ammo':i.family} (${fmtMoney(i.value)})`; sel.appendChild(op); }); }

function renderFactories(){ const el=document.getElementById('factoryList'); el.innerHTML=''; Game.factories.forEach(f=>{ const card=document.createElement('div'); card.className='item-card'; const top=document.createElement('div'); top.className='item-top'; top.innerHTML=`<div style="font-weight:900">${f.name}</div><div class="small-note">Lv ${f.level} • ${Math.max(0,f.activeQueue.length)} queued</div>`; const stats=document.createElement('div'); stats.className='item-stats'; stats.innerHTML=`<div>Speed: ${(f.speed).toFixed(2)}x</div><div>Queue: ${f.queueSize}</div>`; const controls=document.createElement('div'); controls.style.display='flex'; controls.style.gap='8px'; const qBtn=document.createElement('button'); qBtn.className='btn small'; qBtn.textContent='Quick'; qBtn.addEventListener('click',()=>{ autoFill(f); renderFactories(); }); const openBtn=document.createElement('button'); openBtn.className='btn small secondary'; openBtn.textContent='Open'; openBtn.addEventListener('click',()=>showFactoryModal(f)); controls.appendChild(qBtn); controls.appendChild(openBtn); card.appendChild(top); card.appendChild(stats); card.appendChild(controls); const q=document.createElement('div'); q.className='small-note'; q.style.marginTop='8px'; q.textContent=f.activeQueue.length ? 'Queue: '+f.activeQueue.map(x=> (Game.catalog.find(i=>i.id===x.id)?.name||x.id)).slice(0,6).join(', ') : 'Idle'; card.appendChild(q); el.appendChild(card); }); document.getElementById('factorySnapshot').textContent=`${Game.factories.length} factories`; }

function showFactoryModal(f){
  const mb=document.getElementById('modalBackdrop'), md=document.getElementById('modal'); md.innerHTML=`<div style="font-weight:900">${f.name}</div><div class="small-note">Speed ${(f.speed).toFixed(2)}x • Queue ${f.queueSize}</div>`;
  const list=document.createElement('div'); list.style.maxHeight='220px'; list.style.overflow='auto'; list.style.marginTop='10px';
  f.activeQueue.forEach((q,idx)=>{ const d=document.createElement('div'); d.className='small-note'; d.textContent=`${idx+1}. ${Game.catalog.find(i=>i.id===q.id)?.name||q.id} — ${Math.max(0,q.remaining).toFixed(1)}s`; list.appendChild(d);});
  md.appendChild(list);
  const add=document.createElement('div'); add.style.marginTop='10px';
  const sel=document.createElement('select'); sel.style.width='100%';
  const suitable=Game.catalog.filter(i=>{ if(f.proto==='ammo') return i.type==='ammo'; if(f.proto==='handgun') return i.family==='handgun'; if(f.proto==='rifle') return i.family==='rifle'||i.family==='precision'; return true; });
  suitable.forEach(i=>{ const op=document.createElement('option'); op.value=i.id; op.textContent=`${i.name} (${fmtMoney(i.value)})`; sel.appendChild(op); });
  const hdiv=document.createElement('div'); hdiv.style.display='flex'; hdiv.style.gap='8px'; hdiv.style.marginTop='8px';
  const qinput=document.createElement('input'); qinput.type='number'; qinput.value=1; qinput.min=1; qinput.style.width='72px';
  const qbtn=document.createElement('button'); qbtn.className='btn'; qbtn.textContent='Queue';
  qbtn.addEventListener('click',()=>{ const id=sel.value; const qn=parseInt(qinput.value||1,10); enqueue(f,id,qn); renderFactories(); showModal(false); });
  const afill=document.createElement('button'); afill.className='btn secondary'; afill.textContent='Auto x3'; afill.addEventListener('click',()=>{ for(let i=0;i<3;i++) autoFill(f); renderFactories(); showModal(false); });
  hdiv.appendChild(qinput); hdiv.appendChild(qbtn); hdiv.appendChild(afill);
  add.appendChild(sel); add.appendChild(hdiv); md.appendChild(add);
  const close=document.createElement('div'); close.style.marginTop='12px'; const cb=document.createElement('button'); cb.className='btn secondary'; cb.textContent='Close'; cb.addEventListener('click',()=>showModal(false)); close.appendChild(cb); md.appendChild(close);
  mb.style.display='flex';
}
function showModal(flag){ const mb=document.getElementById('modalBackdrop'); if(!flag) mb.style.display='none'; }

/* market, upgrades, research, inventory rendering */
function renderMarket(){ const el=document.getElementById('marketList'); el.innerHTML=''; Game.resourceDefs.forEach(r=>{ const card=document.createElement('div'); card.className='item-card'; card.innerHTML=`<div style="display:flex;justify-content:space-between"><div style="font-weight:900">${r.name}</div><div class="small-note">${fmtMoney(Game.market.prices[r.id])}</div></div><div class="small-note">Stock: ${Game.resources[r.id]||0}</div>`; const btns=document.createElement('div'); btns.style.display='flex'; btns.style.gap='8px'; btns.style.marginTop='8px'; const buy=document.createElement('button'); buy.className='btn small'; buy.textContent='Buy x10'; buy.addEventListener('click',()=>{ const price=Game.market.prices[r.id]*10; if(Game.money<price){ pushLog('Not enough money'); return; } Game.money-=price; Game.resources[r.id]=(Game.resources[r.id]||0)+10; pushLog(`Bought 10 ${r.name} for ${fmtMoney(price)}`); renderResources(); renderMarket(); }); const sell=document.createElement('button'); sell.className='btn small secondary'; sell.textContent='Sell x10'; sell.addEventListener('click',()=>{ if((Game.resources[r.id]||0)<10){ pushLog('Not enough to sell'); return; } const price=Game.market.prices[r.id]*10*(0.82+Math.random()*0.12); Game.resources[r.id]-=10; Game.money+=price; pushLog(`Sold 10 ${r.name} for ${fmtMoney(price)}`); renderResources(); renderMarket(); }); btns.appendChild(buy); btns.appendChild(sell); card.appendChild(btns); el.appendChild(card); });
  const goodsTitle=document.createElement('div'); goodsTitle.style.fontWeight='900'; goodsTitle.style.marginTop='12px'; goodsTitle.textContent='Finished — Sell'; el.appendChild(goodsTitle);
  const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(2,1fr)'; grid.style.gap='8px'; grid.style.marginTop='8px';
  Game.catalog.forEach(item=>{ const cnt=Game.inventory[item.id]||0; if(!cnt) return; const c=document.createElement('div'); c.className='item-card'; c.innerHTML=`<div style="font-weight:900">${item.name}</div><div class="small-note">${cnt} in stock • ${fmtMoney(item.value)}</div>`; const sb=document.createElement('button'); sb.className='btn small'; sb.textContent='Sell x1'; sb.addEventListener('click',()=>{ Game.inventory[item.id]-=1; const price=Math.floor(item.value*(0.7+Math.random()*0.2)); Game.money+=price; Game.stats.sold[item.id]=(Game.stats.sold[item.id]||0)+1; pushLog(`Sold ${item.name} for ${fmtMoney(price)}`); renderMarket(); renderResources(); renderInventory(); }); c.appendChild(sb); grid.appendChild(c); });
  el.appendChild(grid);
}
function renderUpgrades(){ const el=document.getElementById('upgradeList'); el.innerHTML=''; Game.upgradesCatalog.forEach(u=>{ const card=document.createElement('div'); card.className='item-card'; card.innerHTML=`<div style="display:flex;justify-content:space-between"><div style="font-weight:900">${u.name}</div><div class="small-note">${fmtMoney(u.cost)}</div></div><div class="small-note">${u.desc||u.name}</div>`; const b=document.createElement('button'); b.className='btn small'; b.textContent='Buy'; b.addEventListener('click',()=>{ if(Game.money<u.cost){ pushLog('Not enough money'); return; } Game.money-=u.cost; if(u.apply) u.apply(); Game.upgrades[u.id]=true; pushLog(`${u.name} purchased`); renderUpgrades(); renderResources(); }); card.appendChild(b); el.appendChild(card); }); }
function renderResearch(){ const el=document.getElementById('researchList'); el.innerHTML=''; Game.researchCatalog.forEach(r=>{ const c=document.createElement('div'); c.className='item-card'; c.innerHTML=`<div style="font-weight:900">${r.name}</div><div class="small-note">${r.desc}</div><div class="small-note">${r.cost} RP</div>`; const b=document.createElement('button'); b.className='btn small'; b.textContent='Research'; b.addEventListener('click',()=>{ if(Game.researchPoints<r.cost){ pushLog('Not enough RP'); return; } Game.researchPoints-=r.cost; pushLog(`Research complete: ${r.name}`); renderResearch(); }); c.appendChild(b); el.appendChild(c); }); }
function renderInventory(){ const el=document.getElementById('inventoryList'); el.innerHTML=''; Game.catalog.forEach(it=>{ const cnt=Game.inventory[it.id]||0; if(!cnt) return; const card=document.createElement('div'); card.className='item-card'; card.innerHTML=`<div style="font-weight:900">${it.name}</div><div class="small-note">${it.type==='ammo'?'Ammo':'Weapon'} • ${it.caliber||''}</div><div style="font-family:var(--mono);font-weight:900">${cnt}x</div>`; el.appendChild(card); }); }
function renderQuickFactories(){ const el=document.getElementById('quickFactories'); el.innerHTML=''; Game.factories.slice(0,6).forEach(f=>{ const d=document.createElement('div'); d.className='item-card'; d.style.display='flex'; d.style.justifyContent='space-between'; d.innerHTML=`<div><div style="font-weight:900">${f.name}</div><div class="small-note">${Math.max(0,f.activeQueue.length)} queued</div></div><div style="display:flex;flex-direction:column;gap:6px"><button class="btn small">Open</button><button class="btn small secondary">Fill</button></div>`; el.appendChild(d); }); const mt=document.getElementById('marketFeed'); mt.innerHTML=''; Game.resourceDefs.forEach(r=>{ const p=document.createElement('div'); p.className='small-note'; p.textContent=`${r.name}: ${fmtMoney(Game.market.prices[r.id])} (${(Game.market.trends[r.id]*100).toFixed(2)}% trend)`; mt.appendChild(p); }); document.getElementById('queueStatus').textContent = Game.factories.reduce((a,b)=>a+b.activeQueue.length,0) + ' queued'; }
function renderAll(){ renderResources(); renderManualOptions(); renderFactories(); renderMarket(); renderUpgrades(); renderResearch(); renderInventory(); renderQuickFactories(); }

/* Game loop */
function gameTick(){ const now=Date.now(); const dt=(now-Game.lastTick)/1000; Game.lastTick=now;
  updateMarket(dt); Game.factories.forEach(f=>{ tickFactory(f,dt); if(Game.upgrades['u_auto'] && f.activeQueue.length<f.queueSize) autoFill(f); });
  if(Game.upgrades['u_market']) Game.money += Math.floor(2*dt);
  Game.achDefs.forEach(a=>{ if(!Game.achievements[a.id] && a.cond(Game)){ Game.achievements[a.id]=true; if(a.reward) a.reward(); pushLog(`Achievement: ${a.name}`); }});
  renderResources(); renderFactories(); renderMarket(); renderUpgrades(); renderResearch(); renderInventory(); renderQuickFactories();
  if((Date.now()-Game._lastSaveCheck)/1000 > Game.settings.saveInterval){ saveGame(); Game._lastSaveCheck = Date.now(); }
  const c=document.getElementById('clock'); if(c) c.textContent = new Date().toLocaleTimeString();
}
let ticker=null; function startTicker(){ if(ticker) clearInterval(ticker); ticker=setInterval(gameTick,1000); }

/* UI bindings */
document.getElementById('tabs').addEventListener('click',e=>{ const t=e.target.closest('.tab'); if(!t) return; document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active'); const name=t.dataset.tab; document.querySelectorAll('.tab-page').forEach(p=>p.style.display='none'); document.getElementById(name).style.display='block'; });

document.getElementById('craftBtn').addEventListener('click',()=>{ const id=document.getElementById('manualProduct').value; if(craft(id,1)) pushLog('Crafted: ' + (Game.catalog.find(i=>i.id===id).name)); renderAll(); });
document.getElementById('bulkBtn').addEventListener('click',()=>{ const id=document.getElementById('manualProduct').value; if(craft(id,5)) pushLog('Bulk crafted x5'); renderAll(); });

document.getElementById('scavengeBtn').addEventListener('click',()=>{ const picks=randInt(2,4); for(let i=0;i<picks;i++){ const r=randChoice(Game.resourceDefs).id; const amt=randInt(1,6); Game.resources[r]=(Game.resources[r]||0)+amt; pushLog(`Scavenged +${amt} ${r}`);} const m=randInt(8,42); Game.money+=m; pushLog(`Scavenge cash: ${fmtMoney(m)}`); renderAll(); });
document.getElementById('sellLowBtn').addEventListener('click',()=>{ let gained=0; Game.resourceDefs.forEach(r=>{ const qty=Game.resources[r.id]||0; if(qty>20){ const sell=Math.floor(qty/2); const price=Game.market.prices[r.id]*sell*(0.82+Math.random()*0.12); Game.resources[r.id]-=sell; Game.money+=price; gained+=price; }}); pushLog(`Bulk sold low-tier: ${fmtMoney(gained)}`); renderAll(); });
document.getElementById('autoSellBtn').addEventListener('click',()=>{ Game.upgrades['auto_sell']=!Game.upgrades['auto_sell']; pushLog('Auto-sell toggled: '+!!Game.upgrades['auto_sell']); });

document.getElementById('createFactoryBtn').addEventListener('click',()=>{ const type=document.getElementById('designerType').value; const q=parseInt(document.getElementById('designerQueue').value||4,10); const sp=parseFloat(document.getElementById('designerSpeed').value||1); const proto=FactoryProtos[type]; const cost=Math.floor(proto.baseCost*(1+(q-3)*0.08)*(1+(sp-1)*0.35)); if(Game.money<cost){ pushLog('Not enough money'); return; } Game.money-=cost; const f={id:uid('fac'),proto:type,name:`${proto.name} #${Game.factories.length+1}`,level:1,speed:sp,queueSize:q,activeQueue:[],running:true,lastTick:Date.now()}; Game.factories.push(f); pushLog(`Created ${f.name} for ${fmtMoney(cost)}`); renderAll(); });
document.getElementById('create2Btn').addEventListener('click',()=>{ document.getElementById('createFactoryBtn').click(); document.getElementById('createFactoryBtn').click(); });

document.getElementById('modalBackdrop').addEventListener('click',e=>{ if(e.target.id==='modalBackdrop') showModal(false); });
document.getElementById('saveNowBtn').addEventListener('click',()=>saveGame());
document.getElementById('exportBtn').addEventListener('click',()=>exportSave());

const messageSlider=document.getElementById('messageSlider'); const messageLabel=document.getElementById('messageLabel');
messageSlider.addEventListener('input',()=>{ const map=['None','Major (10)','All (200)','Very Large']; Game.settings.messageRetention=parseInt(messageSlider.value,10); messageLabel.textContent=map[Game.settings.messageRetention]||'All'; pushLog('Message retention set to '+messageLabel.textContent); });
document.getElementById('saveInterval').addEventListener('change',e=>{ Game.settings.saveInterval=Math.max(5,parseInt(e.target.value||15,10)); pushLog('Auto-save set: '+Game.settings.saveInterval+'s'); });
document.getElementById('audioToggle').addEventListener('change',e=>{ Game.settings.audio=!!e.target.checked; pushLog('Audio '+(Game.settings.audio?'enabled':'disabled')); });

window.addEventListener('keydown',e=>{ if(e.ctrlKey && e.key==='i'){ const txt=prompt('Paste save JSON to import:'); if(txt) importSaveJSON(txt); } });

/* Init */
loadGame(); renderAll(); startTicker(); pushLog('Armory Forge ready. Have fun.');
window.AF={Game,saveGame,loadGame,pushLog,regItem};
</script>
</body>
</html>
