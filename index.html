<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Armory Forge — Craft & Click (Private)</title>

<!--
=====================================================
Armory Forge — Single-file clicker / incremental game
Theme: militaristic green, factories, resources, weapons, ammo
Safety: NO real manufacturing instructions. Entertainment only.
Author: Generated for user (private)
=====================================================
-->
<style>
/* ===============================
   THEME: Militaristic green, simple layout
   =============================== */

:root{
  --bg:#0f2613;
  --panel:#162e17;
  --muted:#9db79b;
  --accent:#7aa06e;
  --accent-2:#3f6d3f;
  --glass: rgba(255,255,255,0.03);
  --highlight: rgba(255,255,255,0.04);
  --danger: #b53a3a;
  --text:#e6f3e8;
  --mono: 'Courier New', monospace;
  --rounded:12px;
}

*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#09160a);color:var(--text);}
.app{
  display:flex;
  flex-direction:column;
  min-height:100vh;
  padding:18px;
  gap:14px;
}

/* header */
.header{
  display:flex;
  align-items:center;
  gap:12px;
}
.logo{
  width:64px;height:64px;border-radius:10px;background:
    linear-gradient(135deg, rgba(200,220,200,0.075), rgba(80,110,80,0.12));
  border:1px solid rgba(255,255,255,0.03);
  display:flex;align-items:center;justify-content:center;font-weight:700;
  font-family:var(--mono);color:var(--muted);font-size:18px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.6);
}
.title{font-size:20px;font-weight:700;letter-spacing:0.6px;color:var(--text);}
.subtitle{color:var(--muted);font-size:12px;margin-top:4px;}

.top-row{
  display:flex;justify-content:space-between;align-items:center;gap:12px;
}

/* Main content */
.main{
  display:flex;gap:16px;align-items:flex-start;
}

/* left / right panels */
.left-panel{
  width:320px;background:var(--panel);padding:14px;border-radius:var(--rounded);
  box-shadow: 0 6px 24px rgba(0,0,0,0.6);
  border:1px solid rgba(255,255,255,0.03);
  display:flex;flex-direction:column;gap:12px;
}

.center-panel{
  flex:1;background:linear-gradient(180deg, rgba(30,60,30,0.14), rgba(20,40,22,0.06));
  padding:14px;border-radius:var(--rounded);
  min-height:560px; border:1px solid rgba(255,255,255,0.025);
}

/* tabs */
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
.tab{
  background:var(--glass);padding:8px 12px;border-radius:8px;cursor:pointer;
  color:var(--muted);font-size:14px;border:1px solid rgba(255,255,255,0.02);
}
.tab.active{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:white;box-shadow:0 8px 20px rgba(0,0,0,0.6);}

.panel-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;}
.panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);}

/* resource list */
.resource{
  display:flex;gap:10px;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;
  background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
}
.resource .left{display:flex;gap:8px;align-items:center;}
.badge{width:40px;height:40px;border-radius:8px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted);font-family:var(--mono);}

/* factories and lists */
.item-card{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:8px;min-height:86px;}
.item-top{display:flex;justify-content:space-between;align-items:center;}
.item-stats{font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap;}
.btn{background:var(--accent);border:none;padding:8px 10px;border-radius:8px;color:white;cursor:pointer;}
.btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);}
.small{padding:6px 8px;border-radius:7px;font-size:13px;}
.icon{font-family:var(--mono);opacity:0.9}

/* popup modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:20px;}
.modal{background:var(--panel);padding:18px;border-radius:10px;min-width:320px;max-width:900px;border:1px solid rgba(255,255,255,0.025);}

/* marketplace */
.shop-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;}

/* upgrades */
.upgrade-list{display:flex;flex-direction:column;gap:8px;max-height:320px;overflow:auto;padding-right:6px;}

/* footer */
.footer{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;padding:6px 10px;border-radius:8px;background:transparent;border-top:1px solid rgba(255,255,255,0.02);}

/* small helpers */
.flex{display:flex;gap:8px;align-items:center;}
.row{display:flex;gap:8px;align-items:center;}
.hr{height:1px;background:rgba(255,255,255,0.03);margin:6px 0;border-radius:2px;}
.small-note{font-size:12px;color:var(--muted);}

/* responsive */
@media (max-width:900px){
  .main{flex-direction:column;}
  .left-panel{width:100%;}
  .center-panel{width:100%;}
}

/* long comment padding hack to increase file length (ok in CSS) */
/* -------------------------------------------------------------
   This file intentionally includes extended documentation and
   commentary blocks to make the distribution self-contained.
   -------------------------------------------------------------
*/
</style>
</head>
<body>
<div class="app" id="app">
  <div class="top-row header">
    <div style="display:flex;gap:10px;align-items:center">
      <div class="logo">AF</div>
      <div>
        <div class="title">Armory Forge</div>
        <div class="subtitle">Craft, optimize, specialize</div>
      </div>
    </div>
    <div class="flex">
      <div class="small-note">Live Free, Die Free</div>
      <button class="btn small" id="exportBtn">Export Save</button>
      <button class="btn small secondary" id="importBtn">Import Save</button>
    </div>
  </div>

  <div class="main">
    <div class="left-panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;flex-direction:column">
          <div style="font-weight:700">Resources</div>
          <div class="small-note">Prices change randomly — buy low, sell high</div>
        </div>
        <div id="moneyDisplay" style="font-family:var(--mono);font-weight:700;font-size:18px">$0</div>
      </div>

      <div id="resourceList" style="display:flex;flex-direction:column;gap:8px;margin-top:8px;"></div>

      <div class="hr"></div>

      <div style="display:flex;flex-direction:column;gap:8px">
        <div style="font-weight:700">Quick Actions</div>
        <div class="flex">
          <button class="btn small" id="mineBtn">Scavenge Resources</button>
          <button class="btn small secondary" id="sellAllBtn">Sell All Low-Value</button>
        </div>
        <div class="small-note">Scavenge gives random small resources. Selling uses a dynamic market price.</div>
      </div>

      <div class="hr"></div>

      <div>
        <div style="font-weight:700">Active Factories</div>
        <div id="factoryOverview" class="small-note" style="margin-top:6px">None</div>
      </div>

      <div style="flex:1"></div>

      <div class="footer">
        <div>v1.0</div>
        <div id="clock" class="small-note"></div>
      </div>
    </div>

    <div class="center-panel">
      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="dashboard">Dashboard</div>
        <div class="tab" data-tab="factories">Factories</div>
        <div class="tab" data-tab="market">Market</div>
        <div class="tab" data-tab="upgrades">Upgrades</div>
        <div class="tab" data-tab="research">Research</div>
        <div class="tab" data-tab="achievements">Achievements</div>
        <div class="tab" data-tab="inventory">Inventory</div>
        <div class="tab" data-tab="settings">Settings</div>
      </div>

      <div id="tabContent">
        <!-- Dashboard -->
        <div class="tab-page" id="dashboard">
          <div style="display:flex;gap:12px;align-items:flex-start;">
            <div style="flex:1">
              <div style="font-weight:800;font-size:18px">Forge Control</div>
              <div class="small-note">Use factories and manual crafting to produce weapons and ammunition.</div>

              <div class="panel-grid" style="margin-top:12px">
                <div class="panel">
                  <div style="display:flex;justify-content:space-between;align-items:flex-start">
                    <div>
                      <div style="font-weight:800">Manual Crafting</div>
                      <div class="small-note">Click to craft basic parts & weapons.</div>
                    </div>
                    <div class="icon" id="manualRate">0/s</div>
                  </div>
                  <div style="margin-top:10px;display:flex;flex-direction:column;gap:10px">
                    <div style="display:flex;gap:8px;align-items:center">
                      <select id="manualProduct" style="padding:8px;border-radius:8px;background:transparent;color:var(--text);border:1px solid rgba(255,255,255,0.03)">
                      </select>
                      <button class="btn" id="craftBtn">Craft</button>
                      <button class="btn secondary small" id="bulkCraftBtn">Auto x10</button>
                    </div>
                    <div class="small-note">Manual crafting is slower but gives research XP and occasional bonus parts.</div>
                  </div>
                </div>

                <div class="panel">
                  <div style="display:flex;justify-content:space-between">
                    <div>
                      <div style="font-weight:800">Production Queue</div>
                      <div class="small-note">Factories produce over time. Queue capacity varies by factory.</div>
                    </div>
                    <div class="small-note" id="queueStatus">0 queued</div>
                  </div>
                  <div id="queueList" style="margin-top:10px;max-height:180px;overflow:auto"></div>
                </div>
              </div>

              <div style="margin-top:12px">
                <div style="font-weight:800">Recent Events</div>
                <div id="log" style="margin-top:6px;max-height:140px;overflow:auto;background:rgba(255,255,255,0.01);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)"></div>
              </div>

            </div>

            <div style="width:360px">
              <div style="font-weight:800;margin-bottom:8px">Quick Factory Snaps</div>
              <div id="quickFactoryList" style="display:flex;flex-direction:column;gap:8px"></div>

              <div style="height:12px"></div>

              <div style="font-weight:800;margin-bottom:8px">Market Trends</div>
              <div id="marketTrends" class="panel" style="min-height:220px;"></div>

            </div>
          </div>
        </div>

        <!-- Factories -->
        <div class="tab-page" id="factories" style="display:none">
          <div style="display:flex;gap:12px;">
            <div style="flex:1">
              <div style="font-weight:800">Factories</div>
              <div class="small-note">Purchase and upgrade factories that produce specific weapon families and ammo.</div>

              <div style="margin-top:12px" id="factoryList"></div>
            </div>

            <div style="width:360px">
              <div style="font-weight:800">Factory Designer</div>
              <div class="small-note">Create custom assembly lines (queue length, module slots, overclocking).</div>

              <div style="margin-top:8px" class="panel">
                <div style="display:flex;flex-direction:column;gap:8px">
                  <label>Factory Slot Type
                    <select id="designerType" style="margin-left:8px">
                      <option value="handgun">Handgun Shop</option>
                      <option value="rifle">Rifle Plant</option>
                      <option value="heavy">Heavy Systems</option>
                      <option value="precision">Precision Workshop</option>
                      <option value="ammo">Ammo Line</option>
                    </select>
                  </label>
                  <label>Queue Size <input id="designerQueue" type="number" value="5" min="1" max="50" style="width:80px;margin-left:8px"></label>
                  <label>Base Speed Multiplier <input id="designerSpeed" type="number" value="1" step="0.1" min="0.25" style="width:80px;margin-left:8px"></label>

                  <div style="display:flex;gap:8px">
                    <button class="btn" id="createFactoryBtn">Create Factory</button>
                    <button class="btn secondary" id="massCreateBtn">Create x3</button>
                  </div>
                  <div class="small-note">Created factories are added to your active list. Factory design cost scales with specs.</div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Market -->
        <div class="tab-page" id="market" style="display:none">
          <div style="display:flex;gap:12px;">
            <div style="flex:1">
              <div style="font-weight:800">Marketplace</div>
              <div class="small-note">Buy raw resources at fluctuating prices, or buy/sell finished goods.</div>

              <div style="margin-top:12px" id="marketList" class="panel"></div>
            </div>

            <div style="width:320px">
              <div style="font-weight:800">Price Feed</div>
              <div id="priceFeed" class="panel small-note" style="min-height:220px"></div>
            </div>
          </div>
        </div>

        <!-- Upgrades -->
        <div class="tab-page" id="upgrades" style="display:none">
          <div style="display:flex;gap:12px;">
            <div style="flex:1">
              <div style="font-weight:800">Upgrades & Modules</div>
              <div class="small-note">Purchase passive and active boosts, or install modules into factories.</div>

              <div style="margin-top:12px" class="upgrade-list" id="upgradeList"></div>
            </div>

            <div style="width:320px">
              <div class="panel">
                <div style="font-weight:800">Installed Modules</div>
                <div id="installedModules" class="small-note" style="margin-top:8px">No modules installed</div>
              </div>

              <div style="height:12px"></div>

              <div class="panel">
                <div style="font-weight:800">Upgrade Points</div>
                <div id="upgradePoints" style="font-family:var(--mono);font-weight:700">0</div>
                <div class="small-note" style="margin-top:6px">Gain from research and achievements.</div>
              </div>

            </div>
          </div>
        </div>

        <!-- Research -->
        <div class="tab-page" id="research" style="display:none">
          <div style="display:flex;gap:12px;">
            <div style="flex:1">
              <div style="font-weight:800">Research & Blueprints</div>
              <div class="small-note">Spend research to unlock variants, efficiencies, and cosmetic paint templates.</div>

              <div style="margin-top:12px" id="researchList"></div>
            </div>

            <div style="width:320px">
              <div class="panel">
                <div style="font-weight:800">Blueprint Queue</div>
                <div id="bpQueue" class="small-note" style="margin-top:8px">No active research</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Achievements -->
        <div class="tab-page" id="achievements" style="display:none">
          <div>
            <div style="font-weight:800">Achievements</div>
            <div class="small-note">Earn badges for milestones. They give perks.</div>

            <div id="achievementList" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px"></div>
          </div>
        </div>

        <!-- Inventory -->
        <div class="tab-page" id="inventory" style="display:none">
          <div>
            <div style="font-weight:800">Inventory</div>
            <div class="small-note">Your stockpile of components, ammo, and finished weapons.</div>

            <div id="inventoryList" style="margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px"></div>
          </div>
        </div>

        <!-- Settings -->
        <div class="tab-page" id="settings" style="display:none">
          <div>
            <div style="font-weight:800">Settings</div>
            <div class="small-note">This copy is private. Use local saves or import/export to share with friends.</div>

            <div style="margin-top:12px">
              <label>Auto-save interval (sec): <input type="number" id="saveInterval" value="15" min="5" style="width:80px;margin-left:8px"></label>
              <div style="height:8px"></div>
              <label><input type="checkbox" id="audioToggle"> Enable sound effects (minimal)</label>
              <div style="height:8px"></div>
              <label>Difficulty:
                <select id="difficultySelect" style="margin-left:8px">
                  <option value="normal">Normal</option>
                  <option value="slow">Slow Economy</option>
                  <option value="fast">Fast Economy</option>
                  <option value="hard">Competitive (hard)</option>
                </select>
              </label>
            </div>

            <div style="margin-top:12px">
              <div class="small-note">NOTE: This is a private, entertainment-only site. No instructions for real weapon construction are included.</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- modal backdrop -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" id="modal"></div>
</div>

<script>
/*
=====================================================================================
Armory Forge — Game Logic (single-file)
- Extensive, intentionally verbose for completeness
- Safety: No manufacturing instructions; gameplay simulate buy/sell, production, variants
=====================================================================================
*/

/* ===========================
   Utility functions & helpers
   =========================== */

const uid = (prefix='id') => prefix + '_' + Math.random().toString(36).slice(2,9);

function fmtMoney(n){
  if (n < 1000) return '$' + n.toFixed(0);
  if (n < 1000000) return '$' + (n/1000).toFixed(2) + 'k';
  return '$' + (n/1000000).toFixed(2) + 'M';
}

function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

function randInt(min,max){ return Math.floor(min + Math.random()*(max-min+1)); }
function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* ===========================
   Game State — main model
   =========================== */

const Game = {
  version: '1.0',
  money: 1200,
  resources: {},      // counts of raw resources
  resourceDefs: [],   // definitions & prices
  inventory: {},      // finished goods: weapons & ammo
  factories: [],      // active factories
  upgrades: {},       // purchased upgrades
  modules: [],        // installed factory modules
  queue: [],          // global queue (optional)
  researchPoints: 0,
  achievements: {},
  stats: {
    produced: {},
    sold: {},
    clicks: 0,
    timeStarted: Date.now(),
  },
  settings: {
    saveInterval: 15,
    audio: false,
    difficulty: 'normal'
  },
  lastTick: Date.now(),
  running: true,
  fps: 1000 / 1, // tick scale ms (we will use setInterval)
  logLimit: 200,
};


function pushLog(text){
  const el = document.getElementById('log');
  if (!el) return;
  const p = document.createElement('div');
  p.textContent = `[${(new Date()).toLocaleTimeString()}] ${text}`;
  el.prepend(p);
  // trim
  while (el.children.length > 200) el.removeChild(el.lastChild);
}

/* ===========================
   Resource defs - multiple types
   These are intentionally generic: metal, polymer, casing, propellant, electronics
   Prices fluctuate randomly; supply/demand simulation is simplistic and safe.
   =========================== */

Game.resourceDefs = [
  { id:'metal', name:'Metal (Alloy)', icon:'M', basePrice:8, volatility:0.25, storage:1000 },
  { id:'poly', name:'Polymer', icon:'P', basePrice:4, volatility:0.30, storage:1000 },
  { id:'casing', name:'Casings', icon:'C', basePrice:3, volatility:0.20, storage:2000 },
  { id:'prop', name:'Propellant (generic)', icon:'G', basePrice:6, volatility:0.35, storage:1500 },
  { id:'elect', name:'Electronics', icon:'E', basePrice:14, volatility:0.45, storage:600 },
  { id:'optic', name:'Optics', icon:'O', basePrice:22, volatility:0.4, storage:300 },
  { id:'steel', name:'Steel Plate', icon:'S', basePrice:12, volatility:0.2, storage:1200 },
  { id:'spring', name:'Springs & Pins', icon:'R', basePrice:2, volatility:0.18, storage:3000 },
  // add more safe, generic resources if desired
];

Game.resourceDefs.forEach(r => Game.resources[r.id] = Math.floor(Math.random()*50 + 20));

/* ===========================
   Weapon & Ammo Catalog
   - Uses realistic calibers for theme (9mm, .45ACP, .308, .50BMG)
   - Weapon names slightly fictionalized: Block-19, Barret->Garret .50, etc.
   - Each item includes cost in resources, value, production time, rarity, and tags
   =========================== */

Game.catalog = [];

/* Helper to register many similar items quickly */
function registerWeapon(opts){
  Game.catalog.push(Object.assign({
    id: uid('item'),
    name: 'Unnamed',
    type: 'weapon',
    family: 'handgun',
    caliber: '9mm',
    resources: {},
    value: 100,
    prodTime: 3.0, // seconds
    tier: 1,
    variants: [],
    description: '',
    icon: 'W',
  }, opts));
}

/* We'll register a fair number of items to make the game extensive.
   These are *game items only* — not instructions. */

registerWeapon({
  id:'block-19', name:'Block-19 (Compact)', family:'handgun', caliber:'9mm',
  resources: {metal:12, poly:4, casing:6, spring:3},
  value: 220, prodTime:2.5, tier:1,
  description:'A compact duty handgun—reliable and easy to produce.'
});

registerWeapon({
  id:'block-19-variant', name:'Block-19 (Civ. Carry)', family:'handgun', caliber:'9mm',
  resources: {metal:10, poly:5, casing:6, spring:3, elect:1},
  value: 360, prodTime:3.2, tier:2,
  description:'Enhanced with a simple modular frame.'
});

registerWeapon({
  id:'barr-45', name:'Barr-45 (Service)', family:'handgun', caliber:'.45ACP',
  resources: {metal:18, poly:4, casing:8, spring:4},
  value: 370, prodTime:3.6, tier:2,
  description:'.45 service variant; slower to produce, higher value.'
});

// Rifles
registerWeapon({
  id:'harvester-556', name:'Harvester 5.56 (Assault)', family:'rifle', caliber:'5.56mm',
  resources: {metal:32, poly:10, casing:16, spring:6, elect:2},
  value: 980, prodTime:8.5, tier:3,
  description:'Versatile intermediate rifle.'
});
registerWeapon({
  id:'harvester-556-carbine', name:'Harvester Carbine (SBR)', family:'rifle', caliber:'5.56mm',
  resources: {metal:24, poly:8, casing:12, spring:5, elect:2},
  value: 820, prodTime:7.0, tier:3,
  description:'Short-barrel variant for close quarters.'
});

registerWeapon({
  id:'garret-50', name:'Garret .50 (Anti-Material)', family:'heavy', caliber:'.50 BMG',
  resources: {metal:120, steel:48, casing:40, elect:6, optic:3},
  value: 12400, prodTime:48, tier:6,
  description:'Large-caliber long-range system for high-value contracts.'
});

registerWeapon({
  id:'precise-308', name:'Precise .308 (Marksman)', family:'precision', caliber:'.308Win',
  resources: {metal:48, steel:24, optic:5, elect:3},
  value: 4200, prodTime:18, tier:4,
  description:'Precision rifle for long-range engagements.'
});

// Submachine / PDW
registerWeapon({
  id:'pdx-9', name:'PDX-9 (PDW)', family:'pdw', caliber:'9mm',
  resources: {metal:18, poly:6, casing:10, elect:2},
  value: 680, prodTime:5.2, tier:2,
  description:'Compact select-fire PDW.'
});

// Shotgun-like entry (fictional mechanics)
registerWeapon({
  id:'breaker-12', name:'Breaker 12G (Pump)', family:'shotgun', caliber:'12G',
  resources: {metal:40, poly:12, casing:18},
  value: 980, prodTime:7.5, tier:3,
  description:'Short-range pump-action tool.'
});

// Ammunition entries (treat as items you can produce and sell)
function registerAmmo(opts){
  Game.catalog.push(Object.assign({
    id: uid('ammo'),
    name: 'Ammo',
    type: 'ammo',
    caliber: '9mm',
    resources: {},
    perStack: 50,
    value: 4,
    prodTime: 0.8, // seconds per batch
    tier: 1,
    description: ''
  }, opts));
}

registerAmmo({
  id:'ammo-9mm', name:'9mm Rounds (batch)', type:'ammo', caliber:'9mm',
  resources: {casing:5, prop:6, metal:1}, perStack:50, value: 38, prodTime:1.2, tier:1,
  description:'Standard 9mm rounds produced in batches.'
});
registerAmmo({
  id:'ammo-45', name:'.45ACP Rounds (batch)', type:'ammo', caliber:'.45ACP',
  resources: {casing:6, prop:8, metal:1}, perStack:40, value:44, prodTime:1.6, tier:1,
  description:'.45ACP style rounds, larger batches produce slower.'
});
registerAmmo({
  id:'ammo-308', name:'.308 Rounds (pack)', type:'ammo', caliber:'.308Win',
  resources: {casing:8, prop:10, metal:2}, perStack:30, value:88, prodTime:2.6, tier:2,
  description:'Full-power rifle rounds.'
});
registerAmmo({
  id:'ammo-50', name:'.50 BMG Rounds (box)', type:'ammo', caliber:'.50 BMG',
  resources: {casing:30, prop:55, steel:8}, perStack:10, value:620, prodTime:10.4, tier:5,
  description:'Large heavy rounds in small boxes.'
});

/* Create multiple variants programmatically to expand catalog for "extensive" feel */
const baseNames = ['Guardian','Sentinel','Ranger','Striker','Aegis','Viper','Hawk','Falcon','Talon','Marauder'];
const calibers = ['9mm','.45ACP','5.56mm','.308Win','12G'];
for (let i=0;i<18;i++){
  const name = randChoice(baseNames) + ' Mk' + (i+1);
  const cal = randChoice(calibers);
  const tier = clamp(Math.ceil((i+1)/4),1,5);
  const m = Math.floor(10 + i*5 + Math.random()*20);
  registerWeapon({
    id: 'variant_' + i,
    name: name,
    family: (i%3===0? 'rifle' : (i%3===1? 'handgun':'pdw')),
    caliber: cal,
    resources: {metal: m, poly: Math.floor(m/4), casing: Math.floor(m/3), spring: Math.floor(m/8)},
    value: 250 + i*120 + Math.floor(Math.random()*300),
    prodTime: 2 + i*1.2,
    tier: tier,
    description: `Variant ${name} — limited-run variant.`
  });
}

/* Prepopulate inventory with a few items to help starting players */
Game.inventory['ammo-9mm'] = (Game.inventory['ammo-9mm']||0) + 2;
Game.inventory['block-19'] = (Game.inventory['block-19']||0) + 1;

/* ===========================
   Factories — prototypes and creation
   =========================== */

const FactoryPrototypes = {
  handgun: { name:'Handgun Shop', baseCost:750, baseSpeed:1.0, baseQueue:4, tag:'handgun' },
  rifle: { name:'Rifle Plant', baseCost:4200, baseSpeed:0.9, baseQueue:3, tag:'rifle' },
  heavy: { name:'Heavy Systems', baseCost:16000, baseSpeed:0.6, baseQueue:2, tag:'heavy' },
  precision: { name:'Precision Workshop', baseCost:7200, baseSpeed:0.7, baseQueue:2, tag:'precision' },
  ammo: { name:'Ammunition Line', baseCost:900, baseSpeed:1.6, baseQueue:6, tag:'ammo' },
  pdw: { name:'PDW Shop', baseCost:1600, baseSpeed:1.1, baseQueue:5, tag:'pdw' },
};

/* Create initial small factory so player can start producing */
Game.factories.push({
  id: uid('fac'),
  proto: 'handgun',
  name: 'Starter Handgun Shop',
  level: 1,
  speed: FactoryPrototypes['handgun'].baseSpeed,
  queueSize: 4,
  activeQueue: [],
  uptimeBonus: 0,
  lastTick: Date.now(),
  running: true,
  installedModules: [],
});

/* ===========================
   Market & Price dynamics
   Prices fluctuate randomly with momentum to simulate trends.
   =========================== */

Game.market = {
  prices: {},
  trends: {}, // small momentum values
};

Game.resourceDefs.forEach(r => {
  Game.market.prices[r.id] = r.basePrice * (0.8 + Math.random()*0.4);
  Game.market.trends[r.id] = (Math.random()-0.5) * 0.05;
});

/* Price update tick */
function updateMarket(dtSeconds){
  Game.resourceDefs.forEach(r => {
    // trend nudging + volatility random shock
    const current = Game.market.prices[r.id];
    let trend = Game.market.trends[r.id] + (Math.random()-0.5) * 0.02 * dtSeconds;
    // decay trend slowly
    Game.market.trends[r.id] = trend * 0.995;
    let shock = (Math.random()-0.5) * r.volatility * (0.5 + Math.random()) * dtSeconds;
    let newPrice = current * (1 + shock + trend);
    // clamp
    newPrice = Math.max(0.25 * r.basePrice, Math.min(newPrice, 6 * r.basePrice));
    Game.market.prices[r.id] = newPrice;
  });
}

/* ===========================
   Production mechanics
   Factories produce items in their activeQueue; production time affected by speed, upgrades and modules
   =========================== */

function canAffordResources(costs){
  for (const k in costs){
    if ((Game.resources[k] || 0) < costs[k]) return false;
  }
  return true;
}
function deductResources(costs){
  for (const k in costs){
    Game.resources[k] = (Game.resources[k] || 0) - costs[k];
    if (Game.resources[k] < 0) Game.resources[k] = 0;
  }
}
function addInventory(itemId, qty=1){
  Game.inventory[itemId] = (Game.inventory[itemId] || 0) + qty;
  Game.stats.produced[itemId] = (Game.stats.produced[itemId]||0) + qty;
}

/* Queue item structure:
  {id:itemId, remainingTime: seconds, qty:1, factoryId:...}
*/

function enqueueProduction(factory, itemId, qty=1){
  const item = Game.catalog.find(i => i.id === itemId);
  if (!item) return false;
  for (let n=0;n<qty;n++){
    // check resources before enqueueing: require resources now
    if (!canAffordResources(item.resources)){
      pushLog(`Not enough resources to queue ${item.name}.`);
      return false;
    }
    deductResources(item.resources);
    const baseTime = item.prodTime;
    const speed = factory.speed * (1 + factory.uptimeBonus);
    const time = baseTime / speed;
    factory.activeQueue.push({id:itemId, remainingTime: time, origTime: time});
    pushLog(`Queued ${item.name} in ${factory.name}.`);
  }
  return true;
}

/* factory tick: progress active queue */
function tickFactory(factory, dt){
  if (!factory.running) return;
  if (!factory.activeQueue || factory.activeQueue.length === 0) return;
  // pick first item
  const current = factory.activeQueue[0];
  // adjust dt by factory speed and small randomness to make progress uneven
  const jitter = 0.92 + Math.random()*0.16;
  const timeDelta = dt * factory.speed * jitter;
  current.remainingTime -= timeDelta;
  if (current.remainingTime <= 0){
    // produce item
    addInventory(current.id, 1);
    // remove from queue
    factory.activeQueue.shift();
    pushLog(`${Game.catalog.find(i=>i.id===current.id).name} completed in ${factory.name}.`);
    // chance for bonus (rare)
    if (Math.random() < 0.06 + (0.01 * factory.level)){
      // drop a random resource as bonus
      const bonusRes = randChoice(Game.resourceDefs).id;
      const amt = randInt(1,3);
      Game.resources[bonusRes] = (Game.resources[bonusRes]||0) + amt;
      pushLog(`Bonus: +${amt} ${bonusRes}`);
    }
  }
}

/* Auto enqueue helper to keep factories busy if set to auto */
function factoryAutoFill(factory){
  // find matching items for factory proto
  const suitable = Game.catalog.filter(i => {
    if (factory.proto === 'ammo') return i.type === 'ammo';
    if (factory.proto === 'handgun') return i.family === 'handgun';
    if (factory.proto === 'rifle') return i.family === 'rifle';
    if (factory.proto === 'heavy') return i.family === 'heavy';
    if (factory.proto === 'precision') return i.family === 'precision' || i.family === 'rifle';
    if (factory.proto === 'pdw') return i.family === 'pdw' || i.family === 'pdw';
    return true;
  });
  // pick a random item weighted by tier
  if (suitable.length === 0) return;
  const choice = randChoice(suitable);
  enqueueProduction(factory, choice.id, 1);
}

/* ===========================
   Manual craft action
   =========================== */
function craftManual(itemId, bulk=1){
  const item = Game.catalog.find(i => i.id === itemId);
  if (!item) return false;
  // manual craft costs an extra time/resource penalty but gives research XP
  for (let i=0;i<bulk;i++){
    if (!canAffordResources(item.resources)){
      pushLog('Not enough resources to manually craft ' + item.name);
      return false;
    }
    deductResources(item.resources);
    addInventory(item.id, 1);
    Game.stats.clicks += 1;
    // research gain
    Game.researchPoints += 1 + Math.floor(Math.random()*3);
    // small money payout for craftsmanship (sell to local)
    // but don't auto-sell; instead an occasional cashback
    if (Math.random() < 0.15){
      const cash = Math.floor(item.value * (0.08 + Math.random()*0.12));
      Game.money += cash;
      pushLog(`Occasional craft sale: +${fmtMoney(cash)} from ${item.name}`);
    }
  }
  return true;
}

/* ===========================
   Upgrades & modules
   =========================== */

Game.upgradeCatalog = [];

/* helper to add many upgrades */
function registerUpgrade(u){
  u.id = u.id || uid('upg');
  Game.upgradeCatalog.push(u);
}

/* Some basic, then many programmatically generated upgrades */
registerUpgrade({
  id:'upg_speed_handgun', name:'Handgun Production Optimization', cost:1200,
  effect: g => { /* increases speed of handgun factories */ },
  apply: function(){ Game.upgrades['upg_speed_handgun']=true; Game.factories.forEach(f=>{ if (f.proto==='handgun') f.speed *= 1.12; }); pushLog('Applied Handgun Production Optimization'); },
  description:'Increase handgun factory throughput by 12%.'
});

registerUpgrade({
  id:'upg_auto_queue', name:'Auto-Queue Manager', cost:900,
  apply: function(){ Game.upgrades['upg_auto_queue']=true; pushLog('Auto-Queue Manager active. Factories auto-fill.'); },
  description:'Allows automatic refilling of factories when idle.'
});

registerUpgrade({
  id:'upg_market_watch', name:'Market Watcher', cost:600,
  apply: function(){ Game.upgrades['upg_market_watch']=true; pushLog('Market Watcher installed. Price alerts enabled.'); },
  description:'Receive better pricing and a small passive income from arbitrage.'
});

/* Generate numerous incremental upgrades to be "extensive" */
for (let t=1;t<=40;t++){
  registerUpgrade({
    id: 'upg_prod_' + t,
    name: `Production Efficiency Lv${t}`,
    cost: Math.floor(200 * Math.pow(1.25, t)),
    apply: function(){
      Game.upgrades[this.id] = (Game.upgrades[this.id]||0) + 1;
      // global speed buff but small
      Game.factories.forEach(f => { f.speed *= (1 + 0.01 * Math.min(t, 20)); });
      pushLog(`${this.name} applied.`);
    },
    description: `Small global production speed buff (stackable). Tier ${t}.`
  });
}

/* Modules (install in factory slot for special effects) */
Game.moduleCatalog = [
  {id:'mod_overclock', name:'Overclock Module', cost:2200, installCost:300, description:'Short bursts of increased speed at higher maintenance costs.'},
  {id:'mod_precision', name:'Precision Module', cost:3200, installCost:420, description:'Improve quality and yield valuable variants occasionally.'},
  {id:'mod_eff', name:'Efficiency Module', cost:1800, installCost:200, description:'Reduce resource consumption by a small percent.'},
];

/* ===========================
   Research / Blueprints
   =========================== */

Game.researchCatalog = [
  {id:'res_variant_unlock', name:'Variant Unlock', cost:120, effect:'Unlocks a rare weapon variant.'},
  {id:'res_paint_olive', name:'Olive Paint Template', cost:32, effect:'Aesthetic leftover; gives no stat change (cosmetics).'},
  {id:'res_optic_mk1', name:'Optic Integration', cost:220, effect:'Allows production of optics-equipped variants.'}
];

/* Research queue simple */
Game.researchQueue = [];

/* ===========================
   Achievements
   =========================== */
Game.achievementDefs = [
  {id:'ach_first_craft', name:'First Craft', desc:'Craft your first item', condition: s => (s.stats && Object.values(s.stats.produced||{}).reduce((a,b)=>a+b,0)) >= 1, reward: () => { Game.money += 200; pushLog('Achievement reward: $200'); }},
  {id:'ach_mini_empire', name:'Mini Empire', desc:'Own 5 factories', condition: s => (s.factories && s.factories.length >= 5), reward: () => { Game.researchPoints += 50; pushLog('Achievement reward: +50 Research'); }},
  {id:'ach_collector', name:'Collector', desc:'Have 50 inventory items total', condition: s => Object.values(s.inventory||{}).reduce((a,b)=>a+b,0) >= 50, reward: () => { Game.money += 1200; pushLog('Achievement reward: $1200'); }},
];

/* ===========================
   Save / Load
   =========================== */
function saveGame(){
  const save = {
    version: Game.version,
    money: Game.money,
    resources: Game.resources,
    inventory: Game.inventory,
    factories: Game.factories,
    upgrades: Game.upgrades,
    modules: Game.modules,
    researchPoints: Game.researchPoints,
    achievements: Game.achievements,
    stats: Game.stats,
    settings: Game.settings,
    market: Game.market
  };
  localStorage.setItem('armoryforge_save', JSON.stringify(save));
  pushLog('Game saved locally.');
}

function loadGame(){
  const raw = localStorage.getItem('armoryforge_save');
  if (!raw) return false;
  try{
    const s = JSON.parse(raw);
    Game.money = s.money || Game.money;
    Game.resources = s.resources || Game.resources;
    Game.inventory = s.inventory || Game.inventory;
    Game.factories = s.factories || Game.factories;
    Game.upgrades = s.upgrades || Game.upgrades;
    Game.modules = s.modules || Game.modules;
    Game.researchPoints = s.researchPoints || 0;
    Game.achievements = s.achievements || {};
    Game.stats = s.stats || Game.stats;
    Game.settings = s.settings || Game.settings;
    Game.market = s.market || Game.market;
    pushLog('Game loaded from local save.');
    return true;
  }catch(e){
    console.error(e);
    return false;
  }
}

/* Export/import save to/from text */
function exportSave(){
  const s = localStorage.getItem('armoryforge_save') || JSON.stringify({version:Game.version});
  const blob = new Blob([s], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'armoryforge_save.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importSaveFromText(text){
  try{
    const s = JSON.parse(text);
    localStorage.setItem('armoryforge_save', JSON.stringify(s));
    loadGame();
    location.reload();
  }catch(e){
    alert('Invalid save JSON.');
  }
}

/* ===========================
   UI Rendering
   =========================== */

function renderResources(){
  const el = document.getElementById('resourceList');
  el.innerHTML = '';
  Game.resourceDefs.forEach(r => {
    const row = document.createElement('div');
    row.className = 'resource';
    const left = document.createElement('div'); left.className='left';
    const badge = document.createElement('div'); badge.className='badge'; badge.textContent = r.icon;
    const name = document.createElement('div'); name.innerHTML = `<div style="font-weight:700">${r.name}</div><div class="small-note">${r.id}</div>`;
    left.appendChild(badge); left.appendChild(name);
    const right = document.createElement('div'); right.style.textAlign='right';
    const price = Game.market.prices[r.id] || r.basePrice;
    const qty = Game.resources[r.id] || 0;
    right.innerHTML = `<div style="font-weight:800">${fmtMoney(price)}</div><div class="small-note">${qty} in stock</div>`;
    row.appendChild(left); row.appendChild(right);
    el.appendChild(row);
  });
  document.getElementById('moneyDisplay').textContent = fmtMoney(Game.money);
}

/* Render catalog select for manual crafting */
function renderManualOptions(){
  const sel = document.getElementById('manualProduct');
  sel.innerHTML = '';
  // include cheap items first
  const sorted = Game.catalog.slice().sort((a,b)=>a.tier - b.tier || a.value-b.value);
  sorted.forEach(i => {
    const opt = document.createElement('option');
    opt.value = i.id;
    opt.textContent = `${i.name} — ${i.type==='ammo' ? 'Ammo' : i.family} ${i.caliber || ''} (${fmtMoney(i.value)})`;
    sel.appendChild(opt);
  });
}

/* Render factories */
function renderFactories(){
  const el = document.getElementById('factoryList');
  el.innerHTML = '';
  Game.factories.forEach(f => {
    const card = document.createElement('div'); card.className='item-card';
    const top = document.createElement('div'); top.className='item-top';
    top.innerHTML = `<div style="font-weight:800">${f.name}</div><div class="small-note">Lv ${f.level} • ${Math.max(0,f.activeQueue.length)} queued</div>`;
    const stats = document.createElement('div'); stats.className='item-stats';
    stats.innerHTML = `<div>Speed: ${(f.speed).toFixed(2)}x</div><div>Queue: ${f.queueSize}</div><div>Modules: ${f.installedModules?.length || 0}</div>`;
    const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='8px';
    const btnQueue = document.createElement('button'); btnQueue.className='btn small'; btnQueue.textContent='Quick Queue';
    btnQueue.addEventListener('click',()=>{ factoryAutoFill(f); renderFactories(); renderDashboardQuickFactories(); });
    const btnOpen = document.createElement('button'); btnOpen.className='btn small secondary'; btnOpen.textContent='Open';
    btnOpen.addEventListener('click',()=>{ showFactoryModal(f); });
    const btnSell = document.createElement('button'); btnSell.className='btn small secondary'; btnSell.textContent='Sell';
    btnSell.addEventListener('click',()=>{
      if (confirm('Sell this factory for 50% of base cost?')){
        // compute base cost from prototype
        const base = FactoryPrototypes[f.proto].baseCost || 500;
        const refund = Math.floor(base * 0.5);
        Game.money += refund;
        Game.factories = Game.factories.filter(x => x.id !== f.id);
        pushLog(`Sold ${f.name} for ${fmtMoney(refund)}.`);
        renderFactories();
        renderResources();
      }
    });
    controls.appendChild(btnQueue); controls.appendChild(btnOpen); controls.appendChild(btnSell);

    card.appendChild(top);
    card.appendChild(stats);
    card.appendChild(controls);

    // queue preview
    if (f.activeQueue && f.activeQueue.length > 0){
      const q = document.createElement('div'); q.className='small-note';
      q.style.marginTop='8px';
      q.textContent = 'Queue: ' + f.activeQueue.map(x => (Game.catalog.find(i=>i.id===x.id)?.name || x.id)).slice(0,6).join(', ');
      card.appendChild(q);
    } else {
      const q = document.createElement('div'); q.className='small-note'; q.style.marginTop='8px';
      q.textContent = 'Idle';
      card.appendChild(q);
    }

    el.appendChild(card);
  });

  document.getElementById('factoryOverview').textContent = Game.factories.length + ' owned';
}

/* Factory modal */
function showFactoryModal(factory){
  const mb = document.getElementById('modalBackdrop'); const md = document.getElementById('modal');
  md.innerHTML = '';
  const title = document.createElement('div'); title.style.fontWeight='800'; title.textContent = factory.name;
  const subtitle = document.createElement('div'); subtitle.className='small-note'; subtitle.textContent = `Speed ${(factory.speed).toFixed(2)}x • Queue ${factory.queueSize}`;
  md.appendChild(title); md.appendChild(subtitle); md.appendChild(document.createElement('div'));

  const qDiv = document.createElement('div'); qDiv.style.marginTop='10px';
  qDiv.innerHTML = `<div style="font-weight:700">Queue</div>`;
  const list = document.createElement('div'); list.style.maxHeight='200px'; list.style.overflow='auto'; list.style.marginTop='6px';
  factory.activeQueue.forEach((q, idx) => {
    const it = document.createElement('div'); it.className='small-note';
    const name = Game.catalog.find(i=>i.id === q.id)?.name || q.id;
    it.textContent = `${idx+1}. ${name} — ${Math.max(0,q.remainingTime).toFixed(1)}s left`;
    list.appendChild(it);
  });
  qDiv.appendChild(list);
  md.appendChild(qDiv);

  const addDiv = document.createElement('div'); addDiv.style.marginTop='12px';
  addDiv.innerHTML = `<div style="font-weight:700">Add to Queue</div>`;
  const sel = document.createElement('select'); sel.style.width='100%';
  // suitable items
  const suitable = Game.catalog.filter(i=>{
    if (factory.proto === 'ammo') return i.type === 'ammo';
    if (factory.proto === 'handgun') return i.family === 'handgun';
    if (factory.proto === 'rifle') return i.family === 'rifle';
    if (factory.proto === 'heavy') return i.family === 'heavy';
    if (factory.proto === 'precision') return i.family === 'precision' || i.family === 'rifle';
    if (factory.proto === 'pdw') return i.family === 'pdw' || i.family === 'pdw';
    return true;
  });
  suitable.forEach(i=>{
    const op = document.createElement('option');
    op.value = i.id;
    op.textContent = `${i.name} (${fmtMoney(i.value)}) — ${i.type==='ammo'?'Ammo':i.family}`;
    sel.appendChild(op);
  });

  const qtyInput = document.createElement('input'); qtyInput.type='number'; qtyInput.value=1; qtyInput.min=1; qtyInput.style.width='72px'; qtyInput.style.marginLeft='8px';

  const addBtn = document.createElement('button'); addBtn.className='btn'; addBtn.textContent='Queue';
  addBtn.addEventListener('click',()=>{
    const id = sel.value;
    const qty = parseInt(qtyInput.value||1,10);
    for (let n=0;n<qty;n++){
      if (factory.activeQueue.length >= factory.queueSize){
        pushLog('Factory queue full.');
        break;
      }
      const res = enqueueProduction(factory,id,1);
      if (!res) break;
    }
    renderFactories();
    renderDashboardQuickFactories();
    showModal(null);
  });

  const autoBtn = document.createElement('button'); autoBtn.className='btn secondary'; autoBtn.textContent='Auto Fill 5';
  autoBtn.addEventListener('click',()=>{
    for (let i=0;i<5;i++){
      if (factory.activeQueue.length < factory.queueSize){
        factoryAutoFill(factory);
      }
    }
    renderFactories();
    showModal(null);
  });

  addDiv.appendChild(sel);
  addDiv.appendChild(qtyInput);
  addDiv.appendChild(addBtn);
  addDiv.appendChild(autoBtn);
  md.appendChild(addDiv);

  const close = document.createElement('div'); close.style.marginTop='12px';
  const closeBtn = document.createElement('button'); closeBtn.className='btn secondary'; closeBtn.textContent='Close';
  closeBtn.addEventListener('click', ()=>showModal(null));
  close.appendChild(closeBtn); md.appendChild(close);
  showModal(true);
}

/* General modal helper */
function showModal(content){
  const mb = document.getElementById('modalBackdrop');
  const md = document.getElementById('modal');
  if (!content){
    mb.style.display='none';
    md.innerHTML='';
    return;
  }
  mb.style.display='flex';
}

/* Render market list */
function renderMarket(){
  const el = document.getElementById('marketList');
  el.innerHTML = '';
  // show resources for buy/sell
  Game.resourceDefs.forEach(r=>{
    const p = document.createElement('div'); p.className='item-card';
    p.innerHTML = `<div style="display:flex;justify-content:space-between"><div style="font-weight:700">${r.name}</div><div class="small-note">${fmtMoney(Game.market.prices[r.id])}</div></div>
    <div class="small-note">In stock: ${Game.resources[r.id] || 0}</div>`;
    const btns = document.createElement('div'); btns.style.display='flex'; btns.style.gap='8px'; btns.style.marginTop='8px';
    const buy = document.createElement('button'); buy.className='btn small'; buy.textContent='Buy x10';
    buy.addEventListener('click',()=>{
      const price = Game.market.prices[r.id] * 10;
      if (Game.money < price){
        pushLog('Not enough money.');
        return;
      }
      Game.money -= price;
      Game.resources[r.id] = (Game.resources[r.id] || 0) + 10;
      pushLog(`Bought 10 ${r.name} for ${fmtMoney(price)}`);
      renderResources(); renderMarket();
    });
    const sell = document.createElement('button'); sell.className='btn small secondary'; sell.textContent='Sell x10';
    sell.addEventListener('click',()=>{
      if ((Game.resources[r.id]||0) < 10){
        pushLog('Not enough to sell.');
        return;
      }
      const price = Game.market.prices[r.id] * 10 * (0.86 + Math.random()*0.14);
      Game.money += price;
      Game.resources[r.id] -= 10;
      pushLog(`Sold 10 ${r.name} for ${fmtMoney(price)}`);
      renderResources(); renderMarket();
    });
    btns.appendChild(buy); btns.appendChild(sell);
    p.appendChild(btns);
    el.appendChild(p);
  });

  // finished goods marketplace (sell only)
  const goodsTitle = document.createElement('div'); goodsTitle.style.fontWeight='800'; goodsTitle.style.marginTop='12px'; goodsTitle.textContent='Finished Goods — Sell';
  el.appendChild(goodsTitle);

  const goodsGrid = document.createElement('div'); goodsGrid.style.display='grid'; goodsGrid.style.gridTemplateColumns='repeat(2,1fr)'; goodsGrid.style.gap='8px'; goodsGrid.style.marginTop='8px';
  Game.catalog.forEach(item => {
    const cnt = Game.inventory[item.id] || 0;
    if (!cnt) return;
    const g = document.createElement('div'); g.className='item-card';
    g.innerHTML = `<div style="font-weight:700">${item.name}</div><div class="small-note">${cnt} in stock — Value: ${fmtMoney(item.value)}</div>`;
    const sellBtn = document.createElement('button'); sellBtn.className='btn small'; sellBtn.textContent='Sell x1';
    sellBtn.addEventListener('click', ()=>{
      Game.inventory[item.id] -= 1;
      const price = Math.floor(item.value * (0.7 + Math.random()*0.22));
      Game.money += price;
      Game.stats.sold[item.id] = (Game.stats.sold[item.id]||0) + 1;
      pushLog(`Sold ${item.name} for ${fmtMoney(price)}.`);
      renderMarket(); renderResources(); renderInventory();
    });
    g.appendChild(sellBtn);
    goodsGrid.appendChild(g);
  });
  el.appendChild(goodsGrid);

}

/* render upgrades */
function renderUpgrades(){
  const el = document.getElementById('upgradeList');
  el.innerHTML = '';
  Game.upgradeCatalog.forEach(u=>{
    const div = document.createElement('div'); div.className='item-card';
    const top = document.createElement('div'); top.style.display='flex'; top.style.justifyContent='space-between';
    top.innerHTML = `<div style="font-weight:800">${u.name}</div><div class="small-note">${fmtMoney(u.cost)}</div>`;
    const desc = document.createElement('div'); desc.className='small-note'; desc.textContent = u.description || '';
    const buy = document.createElement('button'); buy.className='btn small'; buy.textContent='Purchase';
    buy.addEventListener('click',()=>{
      if (Game.money < u.cost){ pushLog('Not enough money.'); return; }
      Game.money -= u.cost;
      if (u.apply) u.apply();
      else Game.upgrades[u.id] = true;
      pushLog(`${u.name} purchased.`);
      renderUpgrades(); renderResources(); renderFactories();
    });
    div.appendChild(top); div.appendChild(desc); div.appendChild(buy);
    el.appendChild(div);
  });

  document.getElementById('upgradePoints').textContent = Game.researchPoints.toString();
}

/* render research */
function renderResearch(){
  const el = document.getElementById('researchList');
  el.innerHTML = '';
  Game.researchCatalog.forEach(r=>{
    const div = document.createElement('div'); div.className='item-card';
    div.innerHTML = `<div style="display:flex;justify-content:space-between"><div style="font-weight:800">${r.name}</div><div class="small-note">${r.cost} RP</div></div><div class="small-note">${r.effect}</div>`;
    const btn = document.createElement('button'); btn.className='btn small'; btn.textContent='Research';
    btn.addEventListener('click',()=>{
      if (Game.researchPoints < r.cost){ pushLog('Not enough Research Points'); return; }
      Game.researchPoints -= r.cost;
      pushLog(`Research complete: ${r.name}`);
      // effect: for this demo we just grant access or give small buff
      if (r.id === 'res_variant_unlock'){
        // pick a random catalog item and mark variant as unlocked - safe fictional only
        Game.researchPoints += 0; // no-op
        pushLog('A variant blueprint is now available in research results.');
      }
      renderResearch();
    });
    div.appendChild(btn);
    el.appendChild(div);
  });

  document.getElementById('bpQueue').textContent = (Game.researchQueue.length? (Game.researchQueue.map(x=>x.name).join(', ')):'No active research');
}

/* Achievements render */
function renderAchievements(){
  const el = document.getElementById('achievementList');
  el.innerHTML = '';
  Game.achievementDefs.forEach(a=>{
    const attained = Game.achievements[a.id];
    const d = document.createElement('div');
    d.className = 'item-card'; d.style.minWidth='160px';
    d.innerHTML = `<div style="font-weight:800">${a.name}</div><div class="small-note">${a.desc}</div>`;
    if (attained){
      const b = document.createElement('div'); b.className='small-note'; b.textContent='Unlocked';
      d.appendChild(b);
    } else {
      const b = document.createElement('div'); b.className='small-note'; b.textContent='Locked';
      d.appendChild(b);
    }
    el.appendChild(d);
  });
}

/* Inventory render */
function renderInventory(){
  const el = document.getElementById('inventoryList');
  el.innerHTML = '';
  // show all items and ammo
  const catalog = Game.catalog.slice().sort((a,b)=>a.tier - b.tier);
  catalog.forEach(it=>{
    const cnt = Game.inventory[it.id] || 0;
    if (!cnt) return;
    const card = document.createElement('div'); card.className='item-card';
    card.innerHTML = `<div style="font-weight:700">${it.name}</div><div class="small-note">${it.type==='ammo'?'Ammo':'Weapon'} • ${it.caliber || ''}</div><div style="font-family:var(--mono);font-weight:700">${cnt}x</div>`;
    el.appendChild(card);
  });
}

/* Dashboard quick factory list */
function renderDashboardQuickFactories(){
  const el = document.getElementById('quickFactoryList');
  el.innerHTML = '';
  Game.factories.slice(0,6).forEach(f=>{
    const div = document.createElement('div'); div.className='item-card';
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center';
    div.innerHTML = `<div><div style="font-weight:800">${f.name}</div><div class="small-note">${Math.max(0,f.activeQueue.length)} queued</div></div><div style="display:flex;flex-direction:column;gap:6px"><button class="btn small">Open</button><button class="btn small secondary">Fill</button></div>`;
    el.appendChild(div);
  });

  const mt = document.getElementById('marketTrends');
  mt.innerHTML = '<div class="small-note">Recent price movements:</div>';
  Game.resourceDefs.forEach(r=>{
    const p = document.createElement('div'); p.className='small-note';
    const price = Game.market.prices[r.id];
    p.textContent = `${r.name}: ${fmtMoney(price)} (${(Game.market.trends[r.id]*100).toFixed(2)}% trend)`;
    mt.appendChild(p);
  });

  document.getElementById('queueStatus').textContent = Game.factories.reduce((a,b)=>a+b.activeQueue.length,0) + ' queued';
}

/* Initial render call */
function renderAll(){
  renderResources();
  renderManualOptions();
  renderFactories();
  renderMarket();
  renderUpgrades();
  renderResearch();
  renderAchievements();
  renderInventory();
  renderDashboardQuickFactories();
}

/* ===========================
   Ticker loop
   =========================== */

function gameTick(){
  const now = Date.now();
  const dt_ms = now - Game.lastTick;
  const dt = dt_ms / 1000;
  Game.lastTick = now;

  // Market update
  updateMarket(dt);

  // Factories
  Game.factories.forEach(f => {
    // tick factory using dt
    tickFactory(f, dt);
    // auto-fill if upgrade present
    if (Game.upgrades['upg_auto_queue'] && f.activeQueue.length < f.queueSize){
      factoryAutoFill(f);
    }
  });

  // passive income from market watcher
  if (Game.upgrades['upg_market_watch']){
    const inc = Math.floor(6 * Math.random() * (dt));
    Game.money += inc * 0.5;
  }

  // small interest or depreciation based on difficulty
  if (Game.settings.difficulty === 'fast'){
    Game.money += Math.floor(2 * dt);
  } else if (Game.settings.difficulty === 'hard'){
    Game.money -= Math.floor(0.5 * dt);
  }

  // check achievements
  Game.achievementDefs.forEach(a=>{
    if (!Game.achievements[a.id] && a.condition(Game)){
      Game.achievements[a.id] = true;
      if (a.reward) a.reward();
      pushLog(`Achievement unlocked: ${a.name}`);
    }
  });

  // render periodically
  renderResources();
  renderFactories();
  renderMarket();
  renderUpgrades();
  renderResearch();
  renderAchievements();
  renderInventory();
  renderDashboardQuickFactories();

  // auto-save based on settings interval
  if (!Game._lastSaveCheck) Game._lastSaveCheck = Date.now();
  if ((Date.now() - Game._lastSaveCheck) / 1000 > Game.settings.saveInterval){
    saveGame();
    Game._lastSaveCheck = Date.now();
  }

  // update clock
  const c = document.getElementById('clock');
  if (c) c.textContent = new Date().toLocaleTimeString();
}

/* Start the ticker */
let tickInterval = null;
function startTicker(){
  if (tickInterval) clearInterval(tickInterval);
  tickInterval = setInterval(gameTick, 1000);
}

/* ===========================
   UI bindings & interactions
   =========================== */

document.getElementById('tabs').addEventListener('click', (e)=>{
  const tab = e.target.closest('.tab');
  if (!tab) return;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');
  const name = tab.dataset.tab;
  document.querySelectorAll('.tab-page').forEach(page=>page.style.display='none');
  document.getElementById(name).style.display = 'block';
});

/* craft button */
document.getElementById('craftBtn').addEventListener('click', ()=>{
  const id = document.getElementById('manualProduct').value;
  const ok = craftManual(id, 1);
  if (ok) { pushLog('Manually crafted: ' + (Game.catalog.find(i=>i.id===id).name)); }
  renderResources(); renderInventory(); renderUpgrades();
});

/* bulk craft */
document.getElementById('bulkCraftBtn').addEventListener('click', ()=>{
  const id = document.getElementById('manualProduct').value;
  const ok = craftManual(id, 10);
  if (ok) pushLog('Bulk craft x10 complete.');
  renderResources(); renderInventory(); renderUpgrades();
});

/* quick actions */
document.getElementById('mineBtn').addEventListener('click', ()=>{
  // Scavenge: gives random small resources
  const picks = randInt(2,5);
  for (let i=0;i<picks;i++){
    const r = randChoice(Game.resourceDefs).id;
    const amt = randInt(1,8);
    Game.resources[r] = (Game.resources[r] || 0) + amt;
    pushLog(`Scavenged +${amt} ${r}`);
  }
  // small money
  const money = randInt(10,60);
  Game.money += money;
  pushLog(`Scavenge bonus: ${fmtMoney(money)}`);
  renderResources();
});

document.getElementById('sellAllBtn').addEventListener('click', ()=>{
  // sell low-tier resources for quick cash
  let gained = 0;
  Game.resourceDefs.forEach(r=>{
    const qty = Game.resources[r.id] || 0;
    if (qty > 30){
      const sell = Math.floor(qty / 2);
      const price = Game.market.prices[r.id] * sell * (0.82 + Math.random()*0.10);
      Game.resources[r.id] -= sell;
      Game.money += price;
      gained += price;
    }
  });
  pushLog(`Bulk resource liquidation: ${fmtMoney(gained)}`);
  renderResources(); renderMarket();
});

/* create factory */
document.getElementById('createFactoryBtn').addEventListener('click', ()=>{
  const type = document.getElementById('designerType').value;
  const q = parseInt(document.getElementById('designerQueue').value||4,10);
  const sp = parseFloat(document.getElementById('designerSpeed').value||1.0);
  const proto = FactoryPrototypes[type];
  // cost scales with queue and speed
  const cost = Math.floor(proto.baseCost * (1 + (q-3)*0.08) * (1 + (sp-1)*0.45) );
  if (Game.money < cost){
    pushLog('Not enough money to create factory.');
    return;
  }
  Game.money -= cost;
  const f = {
    id: uid('fac'),
    proto: type,
    name: `${proto.name} #${Game.factories.length+1}`,
    level: 1,
    speed: sp,
    queueSize: q,
    activeQueue: [],
    uptimeBonus: 0,
    installedModules: [],
    lastTick: Date.now(),
    running: true,
  };
  Game.factories.push(f);
  pushLog(`Created ${f.name} (${fmtMoney(cost)})`);
  renderFactories(); renderResources(); renderDashboardQuickFactories();
});

/* mass create (3x) */
document.getElementById('massCreateBtn').addEventListener('click', ()=>{
  for (let i=0;i<3;i++){
    document.getElementById('createFactoryBtn').click();
  }
});

/* export/import */
document.getElementById('exportBtn').addEventListener('click', ()=>exportSave());
document.getElementById('importBtn').addEventListener('click', ()=>{
  const txt = prompt('Paste save JSON here:');
  if (!txt) return;
  importSaveFromText(txt);
});

/* modal backdrop click to close */
document.getElementById('modalBackdrop').addEventListener('click', (e)=>{
  if (e.target.id === 'modalBackdrop') showModal(null);
});

/* load default or previous save */
loadGame();

/* initial render and start ticking */
renderAll();
startTicker();

/* expose some debug helpers to window for tinkering (private use only) */
window.AF = {
  Game, registerWeapon, registerAmmo, pushLog, saveGame, loadGame, exportSave, importSaveFromText
};

/* Final log */
pushLog('Armory Forge initialized. Welcome.');

/* ===========================
   Long Design Doc (commented as JS block)
   The following block intentionally sizeable to meet "extensive" requirement
   and to make the single-file self-describing. Feel free to edit.
   =========================== */

/*
-----------------------------------------------------------------------------
ARMORY FORGE — DESIGN NOTES (INTERNAL)
-----------------------------------------------------------------------------
Purpose:
 - Private, entertainment-focused incremental/clicker game for firearm
   enthusiasts. Emphasizes resource management, factory specialization,
   upgrade planning, and collection of variants & cosmetic templates.

Core mechanics:
 - Multiple resources (metal, polymer, casings, propellant, electronics, etc.)
   have fluctuating prices. This creates opportunities for arbitrage and
   planning (buy low, store, sell high).
 - Multiple product classes: handguns, rifles, heavy systems, precision rifles,
   PDWs, shotguns, and ammunition types. Each has different resource profiles
   and production times.
 - Factories can be purchased and customized (queue size, speed multipliers).
 - Upgrades & modules provide broad or targeted bonuses; many small upgrades
   encourage long-term play and tinkering.
 - Research points are earned through manual crafting, achievements, and
   occasional events. Research unlocks blueprints and cosmetics.
 - Achievements reward unique perks, cosmetic templates, and research points.
 - Market momentum & price shocks are simulated with a simple random walk plus
   momentum variable, ensuring unpredictability without being exploitable.

Design constraints and safety:
 - The system must avoid any real-world instructions that could facilitate
   making or modifying real firearms or ammunition. Therefore, all "material"
   descriptions are non-actionable (no tolerances, no load recipes, no
   machining speeds, no primer/powder names, no press instructions).
 - Weapons are fictional game items. Real calibers are referenced for flavor,
   but mechanics and values are purely gamified.
 - All interactions are economic & inventory-focused.

Balancing and progression:
 - Early game: Scavage & manual crafting; small handgun shops & ammo lines.
 - Mid game: Rifles & precision plants; optics & electronics become more valuable.
 - Late game: Heavy systems (long production time and very high value) introduced.
 - Achievements and research provide mid/late-game goals to slow completeing
   the tech tree too quickly.
 - Randomness: production times have jitter; occasional bonuses reduce perfect
   play patterns. Prices fluctuate so monetization (selling) requires attention.
 - Multiplicity of upgrades: 40+ incremental production upgrades are included to
   make "endgame grinding" lengthy.
 - Offline progress: Factories continue to process queue if queued while offline,
   but auto-start and fill only applied if unlocks present.

Extensibility:
 - The catalog arrays are easy to expand: registerWeapon/registerAmmo functions.
 - New factory prototypes can be declared at top and integrated.
 - Module & upgrade effects are applied via `apply()` functions for flexibility.

UI/UX thoughts:
 - Single-page app with tabs; popups for detailed factory control.
 - Minimal animations to keep site light; small audio optional.
 - Save/Load with localStorage; import/export JSON for sharing with friends.
 - Keep color theme subdued and militaristic; green palette, monospaced badges.

Potential expansions (future):
 - Contract missions: one-off high-value sells with delivery constraints.
 - Player-to-player trade (if hosted in a closed server environment; not included).
 - Cosmetic shop for skins (purely visual).
 - Seasonal events that change resource baselines.
 - Offline production balancing (progress factor for long offline time).
 - More advanced research trees with dependencies and branching.

Security & privacy note:
 - This single-file approach stores everything locally in the user's browser (localStorage).
 - For private play with friends, export/import save JSON manually; avoid sharing
   sensitive info.
 - If deploying to GitHub Pages, make repository private if you want to restrict access.

-----------------------------------------------------------------------------
END DESIGN DOCUMENT
-----------------------------------------------------------------------------
*/

/* End of file */
</script>
</body>
</html>
